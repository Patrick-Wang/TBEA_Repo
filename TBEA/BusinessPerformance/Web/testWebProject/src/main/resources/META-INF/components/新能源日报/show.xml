<components>
	<service id="servXnyrb" transaction="transactionManager">

		<sql id="djgrb">
			select 
				id,
				dwid,
				drwc,
				kcjy
			from  
				djgrb
			where 
				date = ${date}
		</sql>
		<sql id="djgyjh">
			select
				dwid,
				yjh
			from  
				djgyjh
			where 
				nf = ${year} and
				yf = ${month}
		</sql>
		<sql id="djgylj">
			select 
				dwid,
				sum(drwc) as ljwc
			from  
				djgrb
			where 
				date &gt; ${cal.day &gt; 25 ? cal.days[25].format : cal.lastMonth.days[25].format} and
				date &lt;= ${cal.date}
			group by
				dwid
		</sql>
		<sql id="djgnjh">
			select
				dwid,
				njh
			from  
				djgnjh
			where 
				nf = ${year}
		</sql>
		<sql id="djgnlj">
			select 
				dwid,
				sum(drwc) as ljwc
			from  
				djgrb
			where 
				date &gt; ${
					(cal.month == 12  &amp;&amp;  cal.day &gt; 25) 
						? cal.days[25].format 
						: cal.lastYear.months[12].days[25].format
					} and
				date &lt;= ${cal.date}
			group by
				dwid
		</sql>
		<list id="dwid" type="int">1002,1003</list>
		<table id="djgResult" rowIds="dwid" global="true">
			<list type="string">一分公司,二分公司</list>
			<list type="double" sql="djgrb" value="2" order="dwid" by="1"/>
			<list type="double" sql="djgrb" value="3" order="dwid" by="1"/>
			<list type="double" sql="djgyjh" value="1" order="dwid" by="0"/>
			<list type="double" sql="djgylj" value="1" order="dwid" by="0"/>
			<col></col>
			<list type="double" sql="djgnjh" value="1" order="dwid" by="0"/>
			<list type="double" sql="djgnlj" value="1" order="dwid" by="0"/>
			<col></col>
			<divCol toCol="5" sub="3" base="4"/>
			<divCol toCol="8" sub="6" base="7"/>
		</table>
		
		
		<sql id="zbdcrb">
			select 
				id,
				zbmc,
				drwc
			from  
				zbdcrb
			where 
				date = ${date}
		</sql>
		<sql id="zbdcyjh">
			select 
				zbmc,
				yjh
			from  
				zbdcyjh
			where 
				nf = ${year} and
				yf = ${month}
		</sql>
		<sql id="zbdcylj">
			select 
				zbmc,
				sum(drwc) as ljwc
			from  
				zbdcrb
			where 
				date &gt; ${cal.day > 25 ? cal.days[25].format : cal.lastMonth.days[25].format} and
				date &lt;= ${cal.date}
			group by
				zbmc
		</sql>
		<sql id="zbdcnjh">
			select 
				zbmc,
				njh
			from  
				zbdcnjh
			where 
				nf = ${year}
		</sql>
		<sql id="zbdcnlj">
			select 
				zbmc,
				sum(drwc) as ljwc
			from  
				zbdcrb
			where 
				date &gt; ${
					(cal.month == 12 &amp;&amp; cal.day > 25) 
						? cal.days[25].format 
						: cal.lastYear.months[12].days[25].format
					} and
				date &lt;= ${cal.date}
			group by
				zbmc
		</sql> 
		
		<list id="zbmc" type="string">发电量,上网电量</list>
		<list id="ids" type="int" >1,2</list>
		<table id="zbdcResult" rowIds="ids" global="true">
			<col list="zbmc"/>
			<list type="double" sql="zbdcrb" value="2" order="zbmc" by="1"/>
			<list type="double" sql="zbdcyjh" value="1" order="zbmc" by="0"/>
			<list type="double" sql="zbdcylj" value="1" order="zbmc" by="0"/>
			<col></col>
			<list type="double" sql="zbdcnjh" value="1" order="zbmc" by="0"/>
			<list type="double" sql="zbdcnlj" value="1" order="zbmc" by="0"/>
			<col></col>
			<divCol toCol="4" sub="2" base="3"/>
			<divCol toCol="7" sub="5" base="6"/>
		</table>
	</service>
	
	<controller id="xnyrbUpdate">

		<context key="cal" value="${request.date.asCalendar}"/>
		<context key="date" value="${cal.date}"/>
		<context key="year" value="${cal.day &lt;= 25 ? cal.year : cal.nextMonth.year}"/>
		<context key="month" value="${cal.day &lt;= 25 ? cal.month : cal.nextMonth.month}"/>
		<callservice id="servXnyrb"/>
		
		<formatter id="djgDf">
			<EmptyFormatter >
				<DefaultMatcher cols="0"/>
			</EmptyFormatter>
			<PercentFormatter reservedCount="1">
				<DefaultMatcher cols="5,8"/>
			</PercentFormatter>
			<NumberFormatter reservedCount="1">
			</NumberFormatter>
		</formatter>
		<formatter id="zbdcDf">
			<EmptyFormatter >
				<DefaultMatcher cols="0"/>
			</EmptyFormatter>
			<PercentFormatter reservedCount="1">
				<DefaultMatcher cols="4,7"/>
			</PercentFormatter>
			<NumberFormatter reservedCount="1">
			</NumberFormatter>
		</formatter>
		
		<formatterServer id="servDjg" table="${djgResult.matrixNoIds}">
			<formatter ref="djgDf"/>
		</formatterServer>
		<formatterServer id="servZbdc" table="${zbdcResult.matrixNoIds}">
			<formatter ref="zbdcDf"/>
		</formatterServer>
		<response type="json"> 
			<header type="array">
				<item>
					<name>分公司</name>
				</item>
				<item>
					<name>当日完成</name>
				</item>
				<item>
					<name>库存结余</name>
				</item>
				<item>
					<name>月计划</name>
				</item>
				<item>
					<name>月累计完成</name>
				</item>
				<item>
					<name>月度完成比</name>
				</item>
				<item>
					<name>年度计划</name>
				</item>
				<item>
					<name>年度累计完成</name>
				</item>
				<item>
					<name>年度累计完成比</name>
				</item>
			</header>
			<data>${servDjg.result}</data>
			<zbdc>
				<header type="array">
					<item>
						<name>分公司</name>
					</item>
					<item>
						<name>当日完成</name>
					</item>
					<item>
						<name>月计划</name>
					</item>
					<item>
						<name>月累计完成</name>
					</item>
					<item>
						<name>月度完成比</name>
					</item>
					<item>
						<name>年度计划</name>
					</item>
					<item>
						<name>年度累计完成</name>
					</item>
					<item>
						<name>年度累计完成比</name>
					</item>
				</header>
				<data>${servZbdc.result}</data>
			</zbdc>
		</response>
	</controller>
	
	<controller id="yszkhkzbExport">

		<context key="dStart" value="${request.dStart.asCalendar.monday}"/>
		<context key="dEnd" value="${request.dEnd.asCalendar.sunday}"/>
		<callservice id="servCompTypeToId"/>
		<callservice id="servYszkhkzb"/>
		<context key="tbs" value="${result.matrixNoIds}"/>
		
		<ExcelTemplate id="excelTemplate" sheet="应收账款回款周报"/>
		
		<list id="title" type="string">
			周期,周期,项目公司,项目名称,客户名称,合同金额,应收账款金额,逾期款金额,逾期款时间（月）
		</list>
				
		<formatter id="data">
			<NumberFormatter reservedCount="1">
				<DefaultMatcher cols="4,5,6"/>
			</NumberFormatter>
			<NumberFormatter reservedCount="0">
				<DefaultMatcher cols="7"/>
			</NumberFormatter>
		</formatter>
		
		<formatter id="excel">
			<ExcelTitleFilter>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="0" col="0"/>
				<titles>
					<title ref="title"></title>
				</titles>
			</ExcelTitleFilter>
			<ExcelMergeFormatter>
				<ExcelTemplate ref="excelTemplate"/>
				<MergeRegion x="0" y="0" width="8" height="1"/>
				<MergeRegion x="0" y="1" width="2" height="${tbs.size}"/>
			</ExcelMergeFormatter>
			<ExcelHeaderCenterFormatter>
				<DefaultMatcher cols="0, 1, 2, 3"/>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="1" col="0"/>
			</ExcelHeaderCenterFormatter>
			<ExcelOffsetFormatter>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="1" col="0"/>
			</ExcelOffsetFormatter>
		</formatter>

		<formatterServer id="serv" table="${tbs}">
			<formatter ref="data"/>
			<formatter ref="excel"/>
		</formatterServer>

		<response type="excel" ref="excelTemplate" name="应收账款回款周报.xls" serv="serv"/>
	</controller>
	
	<controller id="xnyrb">		
		<response type="jsp" name="xnyrb/xnyrb"> 
			<map key="date" value="${calendar.current.format}"/>
			<map key="updateUrl" value="xnyrbUpdate"/>
			<map key="title" value="新能源日报"/>
		</response>
	</controller>
</components>