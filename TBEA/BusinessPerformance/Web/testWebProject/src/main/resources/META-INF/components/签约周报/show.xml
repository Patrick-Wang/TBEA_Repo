<components>
	<service id="servXnyQyzb" transaction="transactionManager">
		
		<sql id="xnyzb">
			select 
				ZB.id, 
				CONVERT(varchar(20), ZB.ksrq, 23) as startDate, 
				CONVERT(varchar(20), ZB.jzrq, 23) as endDate, 
				DWXX.name,
				ZB.khmc,
				ZB.cpmc,
				CONVERT(varchar(20), ZB.ddrq, 23) as ddDate, 
				ZB.qyl,
				ZB.qydj,
				ZB.qyje
			from 
				xny_qyzb ZB, 
				jygk_dwxx DWXX
			where 
				ZB.xmgs = DWXX.id and 
				ZB.xmgs = ${compId} and
				ZB.ksrq &gt;= ${dStart.date} and 
				ZB.jzrq &lt;= ${dEnd.date}
			order by 
				ZB.xmgs
		</sql>
		
		<list id="ids" type="int" sql="xnyzb" value="0">2000</list>
		<list id="ks" type="string" sql="xnyzb" value="1">合计</list>
		<list id="jz" type="string" sql="xnyzb" value="2">合计</list>
		<list id="xmgs" type="string" sql="xnyzb" value="3">合计</list>
		<list id="khmc" type="string" sql="xnyzb" value="4">合计</list> 
		<list id="cpmc" type="string" sql="xnyzb" value="5">合计</list>
		<list id="ddrq" type="date" sql="xnyzb" value="6">合计</list>
		<list id="qyl" type="double" sql="xnyzb" value="7"><item isNull="true"></item></list>
		<list id="qydj" type="double" sql="xnyzb" value="8"><item isNull="true"></item></list>
		<list id="qyje" type="double" sql="xnyzb" value="9"><item isNull="true"></item></list>
		
		<table id="result" rowIds="ids">
			<col list="ks"/>
			<col list="jz"/>
			<col list="khmc"/>
			<col list="cpmc"/>
			<col list="ddrq"/> 
			<col list="qyl"/> 
			<col list="qydj"/>
			<col list="qyje"/>
			<sumRow toId="2000">
				<rangeRows>0, ${ids.size - 2}</rangeRows>
			</sumRow>
		</table>

		<context key="result" value="${result}"/>
	</service>
	
	<controller id="xnyQyzbUpdate">

		<context key="dStart" value="${request.dStart.asCalendar.monday}"/>
		<context key="dEnd" value="${request.dEnd.asCalendar.sunday}"/>
		<callservice id="servCompTypeToId"/>
		<callservice id="servXnyQyzb"/>
		
		<formatter id="data">
			<NumberFormatter reservedCount="1">
				<DefaultMatcher cols="7,8,9"/>
			</NumberFormatter>
		</formatter>

		<formatterServer id="serv" table="${result.matrix}">
			<formatter ref="data"/>
		</formatterServer>
		
		<response type="json"> 
			<header type="array">
				<item>
					<name>周期</name>
				</item>
				<item>
					<name>周期</name>
				</item>
				<item>
					<name>项目公司</name>
					<type>hidden</type>
				</item>
				<item>
					<name>客户名称</name>
				</item>
				<item>
					<name>产品名称</name>
				</item>
				<item>
					<name>签订日期</name>
				</item>
				<item>
					<name>签约量</name>
				</item>
				<item>
					<name>签约单价</name>
				</item>
				<item>
					<name>签约金额</name>
				</item>
			</header>
			<data>${serv.result}</data>
		</response>
	</controller>
	
	<controller id="xnyQyzbExport">

		<context key="dStart" value="${request.dStart.asCalendar.monday}"/>
		<context key="dEnd" value="${request.dEnd.asCalendar.sunday}"/>
		<callservice id="servCompTypeToId"/>
		<callservice id="servXnyQyzb"/>
		<context key="tbs" value="${result.matrixNoIds}"/>
		
		<ExcelTemplate id="excelTemplate" sheet="签约周报"/>
		
		<list id="title" type="string">
			周期,项目公司,客户名称,产品名称,签订日期,签约量,签约单价,签约金额
		</list>
				
		<formatter id="data">
			<NumberFormatter reservedCount="1">
				<DefaultMatcher cols="6,7,8"/>
			</NumberFormatter>
		</formatter>
		
		<formatter id="excel">
			<ExcelTitleFilter>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="0" col="0"/>
				<titles>
					<title ref="${title}"></title>
				</titles>
			</ExcelTitleFilter>
			<ExcelMergeFormatter>
				<ExcelTemplate ref="excelTemplate"/>
				<MergeRegion x="0" y="0" width="9" height="1"/>
				<MergeRegion x="0" y="1" width="6" height="${tbs.size}"/>
			</ExcelMergeFormatter>
			<ExcelTextFormatter>
				<DefaultMatcher cols="0, 1, 2, 3, 4, 5"/>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="1" col="0"/>
			</ExcelTextFormatter>
			<ExcelOffsetFormatter>
				<ExcelTemplate ref="excelTemplate"/>
				<Offset row="1" col="0"/>
			</ExcelOffsetFormatter>
		</formatter>

		<formatterServer id="serv" table="${tbs}">
			<formatter ref="data"/>
			<formatter ref="excel"/>
		</formatterServer>

		<response type="excel" ref="excelTemplate" name="新能源周报.xls" serv="serv"/>
	</controller>
</components>