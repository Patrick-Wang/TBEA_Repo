<components>
	<service id="xnyzbEntryServ" transaction="transactionManager" db="localDB">
		
		<sql id="cpzlSql">
			select 
				id,
				cpzl
			from 
				xnyzb_cpzl
			where 
				xmgs = 903
		</sql>
		
		<list id="cpzl" type="string" sql="cpzlSql" value="1" />

		<context key="cpzl" value="${cpzl}"/>
	</service>
	
	<service id="xnyzbDoEntryServ" transaction="transactionManager" db="localDB">
		<merge data="${data}" id="0" table="xnyzb">
			<where>
				<id type="int" ref="0"/>
			</where>
			<set>
				<ksrq type="date" ref="1"/>
				<jzrq type="date" ref="2"/>
				<xmgs type="int" value="${compId}"/>
				<cpzl type="string" ref="4"/>
				<cpxh type="string" ref="5"/>
				<bzscl type="double" ref="6"/>
				<bzfhl type="double" ref="7"/>
				<bzxsjg type="string" ref="8"/>
			</set>
		</merge>
	</service>
	
	<controller id="xnyzbDoEntry">
		<context key="data" value="${request.data.asJsonArray}"></context>
		<context key="compId" value="${request.compId.asInt}"></context>
		<callservice id="xnyzbDoEntryServ"/>
		<response type="json">
			<errorCode>0</errorCode>
			<message>OK</message>
		</response>
	</controller>
	
	<controller id="xnyzbEntry">

		<context key="dStart" value="${request.dStart.asCalendar.monday}"/>
		<context key="dEnd" value="${request.dEnd.asCalendar.sunday}"/>
		
		<callservice id="xnyzbServ"/>
		<callservice id="xnyzbEntryServ"/>
		<call id="xnyzbAuthComps" object="${EAServ}" method="getAuthedCompanies">
			<param type="object">${session.account}</param>
			<param type="int">22</param>
		</call>
		
		<formatter id="data">
			<NumberFormatter reservedCount="1">
				<DefaultMatcher cols="6,7"/>
			</NumberFormatter>
		</formatter>
		
		<formatterServer id="serv" table="${result.matrix}" acceptNullAs="">
			<formatter ref="data"/>
		</formatterServer>
		
		<response type="json"> 
			<header type="array">
				<item>
					<name>周期</name>
					<sub type="array">
						<item>
							<name>开始</name>
							<type>date</type>
						</item>
						<item>
							<name>截至</name>
							<type>date</type>
						</item>
					</sub>
				</item>
				<item>
					<name>项目公司</name>
					<type>hidden</type>
				</item>
				<item>
					<name>产品种类</name>
					<type>select</type>
					<options>${cpzl}</options>
				</item>
				<item>
					<name>产品型号</name>
					<type>text</type>
				</item>
				<item>
					<name>本周生产量</name>
					
				</item>
				<item>
					<name>本周发货量</name>
				</item>
				<item>
					<name>本周销售价格</name>
					<type>text</type>
				</item>
			</header>
			<data>${serv.result}</data>
		</response>
	</controller>
</components>