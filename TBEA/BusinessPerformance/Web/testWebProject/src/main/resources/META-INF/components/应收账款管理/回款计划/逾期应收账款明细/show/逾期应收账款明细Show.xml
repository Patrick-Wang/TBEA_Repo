<?xml version="1.0" encoding="UTF-8"?>
<components>

	<controller id="delinquentAccountReceivableUpdateClr">
		<context key="cal" value="${request.date.asCalendar}" />
		<callservice id="delinquentAccountReceivableShowServ" />
		<callcontroller id="delinquentAccountReceivableFmtClr" />
		<formatterServer id="fmtServ" table="${result.matrixNoIds}">
			<formatter ref="fmtData" />
		</formatterServer>
		<response type="json">
			<header type="array">
				<item>
					<name> 项目公司	</name>
				</item>
				<item>
					<name> 办事处	</name>
				</item>
				<item>
					<name> 客户单位名称	</name>
				</item>
				<item>
					<name> 项目名称	</name>
				</item>
				<item>
					<name> 客户所属行业	</name>
				</item>
				<item>
					<name> 合同编号	</name>
				</item>
				<item>
					<name> 合同金额（万元）	</name>
				</item>
				<item>
					<name> 业务类型	</name>
				</item>
				<item>
					<name> 逾期款到期时间	</name>
				</item>
				<item>
					<name> 逾期时间	</name>
				</item>
				<item>
					<name> 逾期金额（万元）</name>
				</item>
				<item>
					<name> 款项性质	</name>
				</item>
				<item>
					<name> 发货时间	</name>
				</item>
				<item>
					<name> 到期未回原因	</name>
				</item>
				<item>
					<name> 原因分类	</name>
				</item>
				<item>
					<name> 清收计划及措施	</name>
				</item>
				<item>
					<name> 本月安排	</name>
				</item>
				<item>
					<name> 责任人及联系方式	</name>
				</item>
				<item>
					<name> 督导领导	</name>
				</item>
				<item>
					<name> 现阶段发函情况	</name>
					<sub type="array">
						<item>
							<name> 协商函	</name>
						</item>
						<item>
							<name> 催款函	</name>
						</item>
						<item>
							<name> 律师函	</name>
						</item>
						<item>
							<name> 诉前通知书	</name>
						</item>
					</sub>
				</item>
				<item>
					<name> 风险排查情况	</name>
					<sub type="array">
						<item>
							<name> 是否承诺回款	</name>
						</item>
						<item>
							<name> 回款情况	</name>
						</item>
						<item>
							<name> 现阶段清收措施及成效说明	</name>
						</item>
						<item>
							<name> 判定是否存在风险	</name>
						</item>
					</sub>
				</item>
				<item>
					<name> 内部责任认定及考核情况	</name>
				</item>
			</header>
			<data>${fmtServ.result}</data>
			<shrinkToFit>false</shrinkToFit>
		</response>
	</controller>
	<controller id="delinquentAccountReceivableFmtClr">
		<formatter export="true" id="fmtData">
			<NumberFormatter reservedCount="1">
				<DefaultMatcher cols="6,7,8,9,10,11,12,13" />
			</NumberFormatter>
			<EmptyFormatter />
		</formatter>
	</controller>
	<controller id="delinquentAccountReceivableExportClr">
		<context key="cal" value="${request.date.asCalendar}" />
		<callservice id="delinquentAccountReceivableShowServ" />
		<callcontroller id="delinquentAccountReceivableFmtClr" />
		<ExcelTemplate id="excelTemplate" sheet="逾期应收账款明细" />
		<list id="title" type="string">
				项目公司,办事处,客户单位名称,项目名称,客户所属行业,合同编号,合同金额（万元）,
				业务类型,逾期款到期时间,逾期时间,逾期金额（万元）,款项性质,发货时间,到期未回原因,原因分类,
				清收计划及措施,本月安排,责任人及联系方式,督导领导,现阶段发函情况,现阶段发函情况,现阶段发函情况,
				现阶段发函情况,风险排查情况,风险排查情况,风险排查情况,风险排查情况,内部责任认定及考核情况
		</list>
		<list id="title1" type="string">项目公司,办事处,客户单位名称,项目名称,客户所属行业,
				合同编号,合同金额（万元）,业务类型,逾期款到期时间,逾期时间,逾期金额（万元）,
				款项性质,发货时间,到期未回原因,原因分类,清收计划及措施,本月安排,责任人及联系方式,
				督导领导,协商函,催款函,律师函,诉前通知书,是否承诺回款,回款情况,
				现阶段清收措施及成效说明,判定是否存在风险,内部责任认定及考核情况
		</list>
		<formatter id="excel">
			<ExcelTitleFilter>
				<ExcelTemplate ref="excelTemplate" />
				<Offset col="0" row="0" />
				<titles>
					<title ref="title" />
					<title ref="title1" />
				</titles>
			</ExcelTitleFilter>
			<ExcelMergeFormatter>
				<ExcelTemplate ref="excelTemplate" />
				<MergeRegion x="0" y="0" width="${title.size}" height="2" />
			</ExcelMergeFormatter>
			<ExcelHeaderCenterFormatter>
				<DefaultMatcher cols="0" />
				<ExcelTemplate ref="excelTemplate" />
				<Offset col="0" row="2" />
			</ExcelHeaderCenterFormatter>
			<ExcelOffsetFormatter>
				<ExcelTemplate ref="excelTemplate" />
				<Offset col="0" row="2" />
			</ExcelOffsetFormatter>
		</formatter>
		<formatterServer id="fmtServ" table="${result.matrixNoIds}">
			<formatter ref="fmtData" />
			<formatter ref="excel" />
		</formatterServer>
		<response name="${exportDwmc}${cal.year}年${cal.month}月回款计划.xls"
			ref="excelTemplate" serv="fmtServ" type="excel" />
	</controller>
	<service id="delinquentAccountReceivableShowServ" transaction="transactionManager">
		<if test="${!dwmc.isList}">
			<sql id="data">select
				id,
				company,
				department,
				contractNum,
				customerName,
				projectName,
				businessType,
				prePayment,
				proPayment,
				deliPayment,
				arriPayment,
				workPayment,
				accePayment,
				guarPayment,
				planSum,
				isReduceAR,
				ARStatus,
				ARProperty,
				receProperty,
				operator,
				personIncharge,
				leader,
				progress,
				measure,
				remark
				from ar_received_plan
				where
				company = ${dwmc} and
				nf = ${cal.year} and
				yf = ${cal.month}
			</sql>
		</if>
		<else>
			<sql id="data">select
				id,
				'${compMgr.BMDBOrganization.companyById[dwid].name}（整体）' as total,
				department,
				contractNum,
				customerName,
				projectName,
				businessType,
				prePayment,
				proPayment,
				deliPayment,
				arriPayment,
				workPayment,
				accePayment,
				guarPayment,
				planSum,
				isReduceAR,
				ARStatus,
				ARProperty,
				receProperty,
				operator,
				personIncharge,
				leader,
				progress,
				measure,
				remark
				from ar_received_plan
				where
				company in ${dwmc} and
				nf = ${cal.year} and
				yf = ${cal.month}
			</sql>
		</else>
		<list id="ids" sql="data" value="0" type="int">
			<item>100</item>
		</list>
		<table export="true" id="result" rowIds="ids">
			<list sql="data" type="string" value="1">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="2">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="3">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="4">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="5">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="6">
				<item>合计</item>
			</list>
			<list sql="data" type="double" value="7">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="8">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="9">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="10">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="11">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="12">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="13">
				<item isNull="true" />
			</list>
			<list sql="data" type="double" value="14">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="15">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="16">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="17">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="18">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="19">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="20">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="21">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="22">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="23">
				<item isNull="true" />
			</list>
			<list sql="data" type="string" value="24">
				<item isNull="true" />
			</list>
			<sumRow toRow="${ids.size - 1}">
				<excludeCol>0,1,2,3,4,5,14,15,16,17,18,18,20,21,22,23</excludeCol>
				<rangeRows>0, ${ids.size - 2}</rangeRows>
			</sumRow>
		</table>
	</service>
</components>
