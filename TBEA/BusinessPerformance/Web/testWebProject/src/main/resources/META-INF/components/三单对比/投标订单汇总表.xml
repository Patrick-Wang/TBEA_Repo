<components>
 <service id="servBidCollection" transaction="transactionManager">
  <context key="dTmp" value="${dStart}"/>
  <list id="weeksNames" type="string"/>
  <list id="weeks" type="int"/>
  <loop test="${dTmp.time &lt;= dEnd.time}">
   <list id="weeks" type="int">
    <item>${dTmp.year * 100 + dTmp.week}</item>
   </list>
   <list id="weekNames" type="object">
    <item>${dTmp.weekYear + '年 ' + '第' + dTmp.week + '周'}</item>
   </list>
   <context key="dTmp" value="${dTmp.nextWeek}"/>
  </loop>
  <sql id="tbddhz" order="weeks" by="0" colCount="17">select 
	DATEPART(yy, bidding_date) * 100 + period,
	sum(not_tax_inclusive_price) ntip,
	sum(gross_profit) gp,
	sum(gross_profit) / nullif(sum(not_tax_inclusive_price),0) mll,
	sum(bid_silicon_steel_price) bssp,
	sum(bid_silicon_steel_amount) bssa,
	sum(bid_ele_copper_price) becp,
	sum(bid_ele_copper_amount) beca,
	sum(bid_ele_copper_process_cost) becpc,
	sum(bid_insulating_oil_price) biop,
	sum(bid_insulating_oil_amount) bioa,
	sum(bid_rolled_steel_price) brsp,
	sum(bid_rolled_steel_amount) brsa,
	sum(bid_cardboard_price) bcp,
	sum(bid_cardboard_amount) bca,
	sum(other_material_cost) omc,
	sum(bid_material_total) bmt
from
	JYGK_SDDB_BIDDING_ORDER_DETAILS
where
	dateDiff(yy, bidding_date, ${dStart.date}) &lt; 0 and
	dateDiff(yy, bidding_date, ${dEnd.date}) &gt; 0 and 
	company_name in ${dwmcs}
group by
	DATEPART(yy, bidding_date),
	period</sql>
  <sql id="tbddhzhj">select 
	100 p,
	sum(not_tax_inclusive_price) ntip1,
	sum(gross_profit) gp2,
	sum(gross_profit) / nullif(sum(not_tax_inclusive_price),0) mll3,
	sum(bid_silicon_steel_price) bssp4,
	sum(bid_silicon_steel_amount) bssa5,
	sum(bid_ele_copper_price) becp6,
	sum(bid_ele_copper_amount) beca7,
	sum(bid_ele_copper_process_cost) becpc8,
	sum(bid_insulating_oil_price) biop9,
	sum(bid_insulating_oil_amount) bioa10,
	sum(bid_rolled_steel_price) brsp11,
	sum(bid_rolled_steel_amount) brsa12,
	sum(bid_cardboard_price) bcp13,
	sum(bid_cardboard_amount) bca14,
	sum(other_material_cost) omc15,
	sum(bid_material_total) bmt16
from
	JYGK_SDDB_BIDDING_ORDER_DETAILS
where
	dateDiff(yy, bidding_date, ${dStart.date}) &lt; 0 and
	dateDiff(yy, bidding_date, ${dEnd.date}) &gt; 0 and 
	company_name in ${dwmcs}</sql>
  <list id="tbddhz" type="object">
   <item concat="tbddhzhj"/>
  </list>
  <list id="weeks" type="int">
   <item>100</item>
  </list>
  <list id="weekNames" type="string">
   <item>合计</item>
  </list>
  <context key="counter" value="${counterFactory.newCounter.reset[0]}"/>
  <table id="result" rowIds="weeks" export="true">
   <col list="weekNames"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
   <list type="double" sql="tbddhz" value="${counter.next.val}"/>
  </table>
 </service>
 <controller id="bidCollectionFmtter">
  <formatter id="dataFmt" export="true">
   <EmptyFormatter>
    <DefaultMatcher cols="0"/>
   </EmptyFormatter>
   <PercentFormatter reservedCount="1">
    <DefaultMatcher cols="3"/>
   </PercentFormatter>
   <NumberFormatter reservedCount="1"/>
  </formatter>
 </controller>
 <controller id="bidCollectionParams">
  <context key="dStart" value="${request.dStart.asCalendar}"/>
  <context key="dEnd" value="${request.dEnd.asCalendar}"/>
  <context key="compId" value="${orgs.virtualCYOrg.ids[request.item.asInt]}"/>
  <if test="${50000 == compId}">
   <list id="comps" type="int">1,2,3</list>
   <context key="dwmcs" value="${orgs.virtualCYOrg.namesByIds[comps]}"/>
  </if>
  <if test="${50000 != compId}">
   <context key="dwmcs" value="${orgs.virtualCYOrg.namesByIds[compId.packAsList]}"/>
  </if>
 </controller>
 <controller id="bidCollectionUpdate">
  <callcontroller id="bidCollectionParams"/>
  <callservice id="servBidCollection"/>
  <callcontroller id="bidCollectionFmtter"/>
  <formatterServer id="fmtServBidCollection" table="${result.matrixNoIds}">
   <formatter ref="dataFmt"/>
  </formatterServer>
  <response type="json">
   <header type="array">
    <item>
     <name>时间</name>
    </item>
    <item>
     <name>合同金额</name>
    </item>
    <item>
     <name>毛利额</name>
    </item>
    <item>
     <name>毛利率</name>
    </item>
    <item>
     <name>硅钢</name>
     <sub type="array">
      <item>
       <name>单价</name>
      </item>
      <item>
       <name>用量</name>
      </item>
     </sub>
    </item>
    <item>
     <name>电解铜</name>
     <sub type="array">
      <item>
       <name>单价</name>
      </item>
      <item>
       <name>用量</name>
      </item>
      <item>
       <name>加工费</name>
      </item>
     </sub>
    </item>
    <item>
     <name>变压器油</name>
     <sub type="array">
      <item>
       <name>单价</name>
      </item>
      <item>
       <name>用量</name>
      </item>
     </sub>
    </item>
    <item>
     <name>纸板</name>
     <sub type="array">
      <item>
       <name>单价</name>
      </item>
      <item>
       <name>用量</name>
      </item>
     </sub>
    </item>
    <item>
     <name>钢材</name>
     <sub type="array">
      <item>
       <name>单价</name>
      </item>
      <item>
       <name>用量</name>
      </item>
     </sub>
    </item>
    <item>
     <name>其他材料成本</name>
    </item>
    <item>
     <name>材料成本总计</name>
    </item>
   </header>
   <data>${fmtServBidCollection.result}</data>
  </response>
 </controller>
 <controller id="bidCollectionExport">
  <callcontroller id="bidCollectionParams"/>
  <callservice id="servBidCollection"/>
  <callcontroller id="bidCollectionFmtter"/>
  <ExcelTemplate id="excelTemplate" sheet="投标订单汇总表"/>
  <list id="title1" type="string">时间,合同金额,毛利额,毛利率,硅钢,硅钢,电解铜,电解铜,电解铜,变压器油,变压器油,纸板,纸板,钢材,钢材,其他材料成本,材料成本总计</list>
  <list id="title2" type="string">时间,合同金额,毛利额,毛利率,单价,用量,单价,用量,加工费,单价,用量,,单价,用量,单价,用量,其他材料成本,材料成本总计</list>
  <formatter id="excel">
   <ExcelTitleFilter>
    <ExcelTemplate ref="excelTemplate"/>
    <Offset row="0" col="0"/>
    <titles>
     <title ref="title1"/>
     <title ref="title2"/>
    </titles>
   </ExcelTitleFilter>
   <ExcelMergeFormatter>
    <ExcelTemplate ref="excelTemplate"/>
    <MergeRegion x="0" y="0" width="${title1.size}" height="2"/>
   </ExcelMergeFormatter>
   <ExcelHeaderCenterFormatter>
    <DefaultMatcher cols="0"/>
    <ExcelTemplate ref="excelTemplate"/>
    <Offset row="2" col="0"/>
   </ExcelHeaderCenterFormatter>
   <ExcelOffsetFormatter>
    <ExcelTemplate ref="excelTemplate"/>
    <Offset row="2" col="0"/>
   </ExcelOffsetFormatter>
  </formatter>
  <formatterServer id="servFmt" table="${result.matrixNoIds}">
   <formatter ref="dataFmt"/>
   <formatter ref="excel"/>
  </formatterServer>
  <response type="excel" ref="excelTemplate" name="${request.dStart.asString}到 ${request.dEnd.asString}投标订单汇总表 .xls" serv="servFmt"/>
 </controller>
 <controller id="bidCollection">
  <response type="jsp" name="sddb/sddb">
   <map key="date" value="${calendar.current.format}"/>
   <map key="updateUrl" value="bidCollectionUpdate"/>
   <map key="exportUrl" value="bidCollectionExport"/>
   <map map="${authMgr[23]}"/>
   <map key="title" value="投标订单汇总表"/>
  </response>
 </controller>
</components>
